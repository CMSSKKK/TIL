# 가상 메모리

* 가상 메모리란?
  * 프로세스는 가상 주소를 사용하고, 실제 해당 주소에서 데이터를 읽고/쓸때만 물리 주소로 바꿔주는 형식
  * 가상 주소 : 프로세스가 참조하는 주소
  * 물리 주소 : 실제 메모리 주소
* MMU(Memory Management Unit)
  * CPU에 코드 실행시, 가상 주소 메모리 접근이 필요할 때, 해당 주소를 물리 주소값으로 변환해주는 하드웨어 장치
  * MMU 하드웨어 장치를 통해야 주소 변환이 빠르기 때문에 MMU를 사용함

## 페이징 시스템

* 페이징이란?
  * 크기가 동일한 페이지로 가상 주소 공간과 이에 매칭하는 물리 주소 공간을 관리
  * 하드웨어 지원이 필요함
    * Intel x86 시스템(32bit)에서는 4KB, 2MB, 1GB 지원
  * 리눅스에서는 4KB로 페이징
  * 페이지 번호를 기반으로 가상 주소/물리 주소 매핑 정보를 기록/사용
* 프로세스의 PCB(프로세스 상태 블록)에 Page Table 구조체를 가리키는 주소가 들어 있음
* page Table에는 가상 주소와 물리 주소간 매핑 정보가 있음
* page : 고정되 크기의 block(4KB)
* v = (p, d)
  * v(가상 주소)
  * p(가상 메모리 페이지, 페이지 번호)
  * d(p안에서 참조하는 위치, 변위(오프셋))
  * 가상 주소의 0비트에서 11비트가 변위를 나타내고, 12비트 이상이 페이지 번호가 될 수 있음

* Page Table
  * 물리 주소에 있는 페이지 번호와 해당 페이지의 첫 물리 주소 정보를 매핑한 표
* Paging stystem 동작
  * 해당 프로세스에서 특정 가상 주소에 엑세를 하기위 위해선
    * 해당 프로세의 page table에 해당 가상 주소가 포함된 page번호가 있는 지 확인
    * page 번호가 있으면 이 page가 매핑된 첫 물리 주소를 알아낸다
* Page Table 예시

| 페이지 번호 | 가상 주소 | 물리 주소 | Valid-invalid-bit |
| :---------: | :-------: | :-------: | :---------------: |
|    Page1    | 0000000h  |   0000h   |         v         |
|    page2    | 0000005h  |   2000h   |         v         |
|    Page3    | 000000Ah  |     0     |         i         |



## 페이징 시스템과 MMU

* 프로세스 생성시, 페이지 테이블 정보 생성
  * PCB에서 해당 페이지 테이블 접근 가능하고, 관련 정보는 물리 메모리에 적재
  * 프로세스 구동시, 해당 페이지 테이블 base 주소가 별도 레지스터에 저장(CR3)
  * CPU가 가상 주소 접근시, MMU가 CR3 레지스터를 가지고 온 후, 페이지 테이블 base 주소를 접근해서, 물리 주소를 가져옴